<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tex To Canvas</title>
<script>
MathJax = {
  tex: {
    inlineMath: [
      ['$', '$'],
      ['\\(', '\\)']
    ],
    displayMath: [
      ['$$', '$$'],
      ['\\[', '\\]']
    ],
    processEscapes: true // use \$ to produce a literal dollar sign (true is default)
  },
  svg: {
    scale: 1,                      // global scaling factor for all expressions
    minScale: .5,                  // smallest scaling factor to use
    //matchFontHeight: true,         // true to match ex-height of surrounding font
    mtextInheritFont: false,       // true to make mtext elements use surrounding font
    merrorInheritFont: true,       // true to make merror text use surrounding font
    mathmlSpacing: false,          // true for MathML spacing rules, false for TeX rules
    skipAttributes: {},            // RFDa and other attributes NOT to copy to the output
    exFactor: .5,                  // default size of ex in em units
    displayAlign: 'center',        // default for indentalign when set to 'auto'
    displayIndent: '0',            // default for indentshift when set to 'auto'
    fontCache: 'local',            // or 'global' or 'none'
    localID: null,                 // ID to use for local font cache (for single equation processing)
    internalSpeechTitles: true,    // insert <title> tags with speech content
    titleID: 0                     // initial id number to use for aria-labeledby titles
  },
};
</script>
<script id="MathJax-script" async src="js/tex-svg-full.js"></script>
<script src="js/matrix.js"></script>
<script src="js/svg-parser.js"></script>
<script src="js/curve.js"></script>
<script src="js/utility.js"></script>
<script>
/*
[bug]
・8が読み取れない
・"備"がエラーが出てしまう 
   -> プロパティ内に半角スペースがあるのが原因かな？
   -> 半角スペースを削除したがダメ
   -> m(小文字)の処理がうまくできていない感じがする
[memo]
・16進数コードから漢字に変換するプログラムを作成する
  --> 参考: http://d.hatena.ne.jp/yasuhallabo/20140211/1392131668
*/
// 参考URL
// https://stackoverflow.com/questions/71031646/write-svg-latex-into-a-canvas-html
// 課題
// インラインの表示がうまくいかない
// 改行ができない
// もうね \begin{eqnarray}日本語x^2\\x^3\end{eqnarray}でいいと思うんだ
// textareaに色付けたいかな -> ace.jsでいけそう
// 文字の色、黒板に白いチョークで書いたようにしたい -> 以前動画のタイトルを作ったやつがあるはずなので、探す

// TODO 
// ・線分, ベジェ曲線の線分の矩形を求める関数 => これ、実際描画するのが一番良いと思う
// ・日本語入力したときはpathが取れない？
// ・なので日本語入力には対応しないでいいんじゃないかな？
// objectMatrix, viewportMatrix,
// ・分数などpathの存在しないものもあるので調べる。分数の区切り線は<rect>

// TODO 図形のtexはいけるはず
// 以下がいけない。texclipではいける。うーん問題だね
/*
\begin{picture}(40,40)(-20,-20)
  \put(-20,-20){\framebox(40,40){}}% 外見の領域全体を囲む枠
  \put(0,0){\circle*{4}}% 原点の位置
\end{picture}
*/

/**
 * 開発用TODO
 * 
 */

// <path> の id が - でいくつに区切られているか
const PATH_ID_SEPARATE_COUNT = 5;


document.addEventListener('DOMContentLoaded', () => {

    init();	
    attachEvents();

    function init() {
        // 入力の初期化
        const text = 
`\\huge{\\begin{eqnarray}
8\\\\
\\end{eqnarray}}`;
        document.querySelector('#textarea').value = text;        
    }

    function attachEvents() {
        // ボタン押下時の処理
        document.querySelector('#button').addEventListener('click', svg2canvas);

        // テキストでCtrl + Sした時の処理
        document.querySelector('#textarea').addEventListener('keydown', e => {
            if(e.ctrlKey && e.key === 's') {
                e.preventDefault(); // Prevent the Save dialog to open
                svg2canvas();   
            }
        });
    }

    function svg2canvas() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        // 数式(MathJax用)
        const equation = document.querySelector('#textarea').value;
        // svgに変換
        const svgText = SvgParser.getMathJaxSvgText(equation);
        // パースする
        const svgData = SvgParser.parseMathJaxSvg(svgText);
        
        const img = document.createElement('img');
        img.onload = (e) => {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.drawImage(e.target, 0, 0, e.target.naturalWidth, e.target.naturalHeight);
            drawSvg(svgData);  
        }
        img.src = 'data:image/svg+xml;base64,' + btoa('<?xml version="1.0" encoding="UTF-8" standalone="no" ?>\n' + svgText);        

        // svgDataに基づいて描画
        function drawSvg(svgData) {
            
            ctx.save();

            // ビューポート変換行列
            Matrix.setTransform(ctx, svgData.vpMat);

            svgData.geoms.forEach((geom, gi) => {
                ctx.save();
                // オブジェクト変換行列をかける
                Matrix.transform(ctx, geom.mat);

                // 描画するpathを取得する
                const path = svgData.paths.find(p => p.c === geom.c);
                if(!path) { return; } // continue;                

                // 描画する
                ctx.strokeStyle = 'green';
                ctx.fillStyle = 'green';
                ctx.lineWidth = 10;
                ctx.beginPath();

                path.curvesArray.forEach(curves => {
                    curves.forEach((curve, i) => { 
                        curve.path(ctx, i === 0); 
                    });
                });

                ctx.closePath();
                ctx.fill();

                const rect = path.rect;
                ctx.strokeStyle = 'red';
                ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);

                ctx.restore();
            });

            ctx.restore();
        }
    }
});
/**
 * 記号メモ
 * MJX-29-TEX-N-32 のように MJX-の後ろの数値は増えるので TEX以下をメモとして残す。
 * TEX-N-30 ～ TEX-N-39: 0 ～ 9
 * TEX-I-1D44E ～ TEX-I-1D467: a ～ z
 * TEX-I-1D434 ～ TEX-I-1D44D: A ～ Z
 * TEX-N-2B: +
 * TEX-N-2212: -
 * TEX-N-2217: *
 * TEX-N-2F: /
 * TEX-LO-222B: \int
 **/	
</script>
<style>
#textarea {
	width: 600px;
	height: 200px;
    font-size: 18px;
}
#canvas {
  border: 1px solid #eeeeee;
}
#debug-canvas {
  border: 1px solid blue;
}
</style>
</head>
<body>
	<textarea id="textarea"></textarea><br>
	<button id="button">tex2svg</button><br><br>
	<canvas id="canvas" width="400" height="400"></canvas>
    <canvas id="debug-canvas" width="400" height="400"></canvas>
</body>
</html>
